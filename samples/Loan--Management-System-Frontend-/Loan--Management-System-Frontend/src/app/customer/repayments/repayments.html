<div class="section">

  <h2>Repayments</h2>

  <!-- LOADING -->
  <div *ngIf="loading" class="info">
    Loading EMI schedule...
  </div>

  <!-- ERROR -->
  <div *ngIf="error" class="error">
    {{ error }}
  </div>

  <!-- LOAN SUMMARY -->
  <div class="card" *ngIf="activeLoan">
    <h3>{{ activeLoan.loanType }} Loan</h3>

    <div class="grid">
      <p>
        <strong>Principal:</strong>
        ₹ {{ activeLoan.principal | number:'1.0-0' }}
      </p>

      <p>
        <strong>Tenure:</strong>
        {{ activeLoan.tenureMonths }} months
      </p>

      <p>
        <strong>Status:</strong>
        {{ activeLoan.status }}
      </p>
    </div>
  </div>

  <!-- EMI TABLE -->
  <table *ngIf="emis.length">
    <thead>
      <tr>
        <th>EMI #</th>
        <th>Due Date</th>
        <th>Amount</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let emi of emis">

        <td>{{ emi.emiNumber }}</td>

        <td>{{ emi.dueDate | date:'mediumDate' }}</td>

        <td>
          ₹ {{ emi.emiAmount | number:'1.0-0' }}
        </td>

        <!-- STATUS -->
        <td>
          <span
            class="status"
            [ngClass]="emi.status.toLowerCase()"
          >
            {{ emi.status }}
          </span>
        </td>

        <!-- ACTION -->
        <td>

          <!-- ✅ ONLY NEXT UNPAID EMI -->
          <button
            *ngIf="canPayEmi(emi)"
            class="pay-btn"
            (click)="payEmi(emi)"
            
          >
            {{ payingEmiNumber === emi.emiNumber ? 'Paying...' : 'Pay Now' }}
          </button>

          <!-- ✅ PAID -->
          <span
            *ngIf="emi.status === 'PAID'"
            class="paid-label"
          >
            Paid
          </span>

          <!-- ✅ FUTURE EMIs -->
          <span
            *ngIf="emi.status !== 'PAID' && !canPayEmi(emi)"
            class="info"
          >
            —
          </span>

        </td>
      </tr>
    </tbody>
  </table>

</div>
